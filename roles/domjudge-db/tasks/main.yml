---

- name: Ensure MariaDB is installed
  ansible.builtin.package:
    name: mariadb-server
    state: present
  become: true

- name: Ensure MariaDB is running
  ansible.builtin.service:
    name: mariadb
    enabled: true
    state: started
  become: true

- name: Set MariaDB root password
  community.mysql.mysql_user:
    check_implicit_admin: true
    login_user: root
    login_password: "{{ db_admin_password }}"
    user: root
    password: "{{ db_admin_password }}"
    host: localhost
  become: true

- name: Generate database credentials file if missing
  ansible.builtin.command: ./dj_setup_database genpass
  args:
    chdir: /home/{{ username }}/Domjudge/domserver/bin
    creates: /home/{{ username }}/Domjudge/domserver/etc/dbpasswords.secret
  become_user: "{{ username }}"
  no_log: true

- name: Check if Domjudge database already exists
  community.mysql.mysql_query:
    login_user: root
    login_password: "{{ db_admin_password }}"
    query: "SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME = 'domjudge';"
  register: domjudge_db_check
  become: true
  no_log: true

- name: Run Domjudge database setup script if not present
  ansible.builtin.command: >
    ./dj_setup_database -u root -p {{ db_admin_password }} install
  args:
    chdir: /home/{{ username }}/Domjudge/domserver/bin
  become: true
  when: domjudge_db_check.query_result[0] | length == 0
  register: domjudge_install
  changed_when: domjudge_install.rc == 0

- name: Debug output for database creation
  ansible.builtin.debug:
    msg: >-
      {% if domjudge_db_check.query_result[0] | length > 0 %}
        Database 'domjudge' already exists, skipping installation.
      {% else %}
        Database 'domjudge' has been created.
      {% endif %}
